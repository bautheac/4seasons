readxl::read_excel(file, sheet = x, skip = 1L)
file <- "data/Market data.xlsm"
readxl::read_excel(file, sheet = x, skip = 1L)
names(readxl::read_excel(file, sheet = x, skip = 1L))
readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`, `aggregate open interest` = FUT_AGGTE_OPEN_INT,
`aggregate volume` = FUT_AGGTE_VOL, `date second` = `Date..11`, `price second` = `PX_LAST..15`) %>% dplyr::slice(2L:n())
readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`, `aggregate open interest` = FUT_AGGTE_OPEN_INT,
`aggregate volume` = FUT_AGGTE_VOL, `date second` = `Date..11`, `price second` = `PX_LAST..15`) %>% dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date))
readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`, `aggregate open interest` = FUT_AGGTE_OPEN_INT,
`aggregate volume` = FUT_AGGTE_VOL, `date second` = `Date..11`, `price second` = `PX_LAST..15`) %>% dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
returns <- dplyr::select(data, `date front`, `price front`) %>% dplyr::mutate(return = `price front` / dplyr::lag(`price front`) - 1L)
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
dplyr::select(data, `date front`, `price front`) %>% dplyr::mutate(return = `price front` / dplyr::lag(`price front`) - 1L)
returns <- dplyr::select(data, date = `date front`, `price front`) %>% dplyr::mutate(return = `price front` / dplyr::lag(`price front`) - 1L) %>%
dplyr::select(date, return)
returns
data
dplyr::full_join(dplyr::select(returns, date = `date front`, `price front`), dplyr::select(returns, date = `date second`, `price second`), by = "date")
dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date")
returns <- dplyr::select(data, date = `date front`, `price front`) %>%
dplyr::mutate(return = `price front` / dplyr::lag(`price front`, 1L) - 1L) %>%
dplyr::select(date, return)
`open interest` <- dplyr::select(data, date = `date front`, `open interest`) %>%
dplyr::mutate(`open interest growth` = `open interest` / dplyr::lag(`open interest`, 1L) - 1L) %>%
dplyr::select(date, `open interest growth`)
`aggregate open interest` <- dplyr::select(data, date = `date front`, `aggregate open interest`) %>%
dplyr::mutate(`aggregate open interest growth` = `aggregate open interest` / dplyr::lag(`aggregate open interest`, 1L) - 1L) %>%
dplyr::select(date, `aggregate open interest growth`)
`roll yield` <- dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date") %>%
dplyr::mutate(`roll yield` = `price second` / `price front`) %>% dplyr::select(date, `roll yield`)
do.call(args = list(returns, `open interest`, `aggregate open interest`, `roll yield`), what = "dplyr::full_join")
do.call(args = list(returns, `open interest`, `aggregate open interest`, `roll yield`), what = "dplyr::full_join()")
dplyr::full_join(list(returns, `open interest`, `aggregate open interest`, `roll yield`))
plyr::join_all(list(returns, `open interest`, `aggregate open interest`, `roll yield`), by = "date", type = "full")
market <- lapply(tickers$`active contract ticker`, function(x){
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
returns <- dplyr::select(data, date = `date front`, `price front`) %>%
dplyr::mutate(return = `price front` / dplyr::lag(`price front`, 1L) - 1L) %>%
dplyr::select(date, return)
`open interest` <- dplyr::select(data, date = `date front`, `open interest`) %>%
dplyr::mutate(`open interest growth` = `open interest` / dplyr::lag(`open interest`, 1L) - 1L) %>%
dplyr::select(date, `open interest`, `open interest growth`)
`aggregate open interest` <- dplyr::select(data, date = `date front`, `aggregate open interest`) %>%
dplyr::mutate(`aggregate open interest growth` = `aggregate open interest` / dplyr::lag(`aggregate open interest`, 1L) - 1L) %>%
dplyr::select(date, `aggregate open interest`, `aggregate open interest growth`)
`roll yield` <- dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date") %>%
dplyr::mutate(`roll yield` = `price second` / `price front`) %>% dplyr::select(date, `roll yield`)
plyr::join_all(list(returns, `open interest`, `aggregate open interest`, `roll yield`), by = "date", type = "full") %>%
dplyr::mutate(`active contract ticker` = x) %>% dplyr::select(`active contract ticker`, dplyr::everything())
}) %>% do.call(args = ., what = "rbind")
market <- lapply(tickers$`active contract ticker`, function(x){
message(paste0("\nLoading ", x, "."))
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
returns <- dplyr::select(data, date = `date front`, `price front`) %>%
dplyr::mutate(return = `price front` / dplyr::lag(`price front`, 1L) - 1L) %>%
dplyr::select(date, return)
`open interest` <- dplyr::select(data, date = `date front`, `open interest`) %>%
dplyr::mutate(`open interest growth` = `open interest` / dplyr::lag(`open interest`, 1L) - 1L) %>%
dplyr::select(date, `open interest`, `open interest growth`)
`aggregate open interest` <- dplyr::select(data, date = `date front`, `aggregate open interest`) %>%
dplyr::mutate(`aggregate open interest growth` = `aggregate open interest` / dplyr::lag(`aggregate open interest`, 1L) - 1L) %>%
dplyr::select(date, `aggregate open interest`, `aggregate open interest growth`)
`roll yield` <- dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date") %>%
dplyr::mutate(`roll yield` = `price second` / `price front`) %>% dplyr::select(date, `roll yield`)
plyr::join_all(list(returns, `open interest`, `aggregate open interest`, `roll yield`), by = "date", type = "full") %>%
dplyr::mutate(`active contract ticker` = x) %>% dplyr::select(`active contract ticker`, dplyr::everything())
}) %>% do.call(args = ., what = "rbind")
x <- "FCA Comdty"
readxl::read_excel(file, sheet = x, skip = 1L)
x <- "LBA Comdty"
readxl::read_excel(file, sheet = x, skip = 1L)
tickers$`active contract ticker`
x <- "LHA Comdty"
readxl::read_excel(file, sheet = x, skip = 1L)
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
x <- "FCA Comdty"
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
readxl::read_excel(file, sheet = x, skip = 1L)
readxl::read_excel(file, sheet = x, skip = 1L)
cftc
unique(cftc$`active contract ticker`)
View(tickers)
View(tickers)
market <- lapply(c(unique(cftc$`active contract ticker`), c("LAA Comdty", "LPA Comdty", "LLA Comdty", "LNA Comdty", "LTA Comdty", "LXA Comdty")), function(x){
message(paste0("\nLoading ", x, "."))
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
returns <- dplyr::select(data, date = `date front`, `price front`) %>%
dplyr::mutate(return = `price front` / dplyr::lag(`price front`, 1L) - 1L) %>%
dplyr::select(date, return)
`open interest` <- dplyr::select(data, date = `date front`, `open interest`) %>%
dplyr::mutate(`open interest growth` = `open interest` / dplyr::lag(`open interest`, 1L) - 1L) %>%
dplyr::select(date, `open interest`, `open interest growth`)
`aggregate open interest` <- dplyr::select(data, date = `date front`, `aggregate open interest`) %>%
dplyr::mutate(`aggregate open interest growth` = `aggregate open interest` / dplyr::lag(`aggregate open interest`, 1L) - 1L) %>%
dplyr::select(date, `aggregate open interest`, `aggregate open interest growth`)
`roll yield` <- dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date") %>%
dplyr::mutate(`roll yield` = `price second` / `price front`) %>% dplyr::select(date, `roll yield`)
plyr::join_all(list(returns, `open interest`, `aggregate open interest`, `roll yield`), by = "date", type = "full") %>%
dplyr::mutate(`active contract ticker` = x) %>% dplyr::select(`active contract ticker`, dplyr::everything())
}) %>% do.call(args = ., what = "rbind")
x <- "FCA Comdty"
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
returns <- dplyr::select(data, date = `date front`, `price front`) %>%
dplyr::mutate(return = `price front` / dplyr::lag(`price front`, 1L) - 1L) %>%
dplyr::select(date, return)
`open interest` <- dplyr::select(data, date = `date front`, `open interest`) %>%
dplyr::mutate(`open interest growth` = `open interest` / dplyr::lag(`open interest`, 1L) - 1L) %>%
dplyr::select(date, `open interest`, `open interest growth`)
`aggregate open interest` <- dplyr::select(data, date = `date front`, `aggregate open interest`) %>%
dplyr::mutate(`aggregate open interest growth` = `aggregate open interest` / dplyr::lag(`aggregate open interest`, 1L) - 1L) %>%
dplyr::select(date, `aggregate open interest`, `aggregate open interest growth`)
`roll yield` <- dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date") %>%
dplyr::mutate(`roll yield` = `price second` / `price front`) %>% dplyr::select(date, `roll yield`)
plyr::join_all(list(returns, `open interest`, `aggregate open interest`, `roll yield`), by = "date", type = "full") %>%
dplyr::mutate(`active contract ticker` = x) %>% dplyr::select(`active contract ticker`, dplyr::everything())
market <- lapply(c(unique(cftc$`active contract ticker`), c("LAA Comdty", "LPA Comdty", "LLA Comdty", "LNA Comdty", "LTA Comdty", "LXA Comdty")), function(x){
message(paste0("\nLoading ", x, "."))
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
returns <- dplyr::select(data, date = `date front`, `price front`) %>%
dplyr::mutate(return = `price front` / dplyr::lag(`price front`, 1L) - 1L) %>%
dplyr::select(date, return)
`open interest` <- dplyr::select(data, date = `date front`, `open interest`) %>%
dplyr::mutate(`open interest growth` = `open interest` / dplyr::lag(`open interest`, 1L) - 1L) %>%
dplyr::select(date, `open interest`, `open interest growth`)
`aggregate open interest` <- dplyr::select(data, date = `date front`, `aggregate open interest`) %>%
dplyr::mutate(`aggregate open interest growth` = `aggregate open interest` / dplyr::lag(`aggregate open interest`, 1L) - 1L) %>%
dplyr::select(date, `aggregate open interest`, `aggregate open interest growth`)
`roll yield` <- dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date") %>%
dplyr::mutate(`roll yield` = `price second` / `price front`) %>% dplyr::select(date, `roll yield`)
plyr::join_all(list(returns, `open interest`, `aggregate open interest`, `roll yield`), by = "date", type = "full") %>%
dplyr::mutate(`active contract ticker` = x) %>% dplyr::select(`active contract ticker`, dplyr::everything())
}) %>% do.call(args = ., what = "rbind")
dplyr::select(market, return)
market
dplyr::select(market, `active contract ticker`, date, return) %>%
tidyr::spread(`active contract ticker`)
dplyr::select(market, `active contract ticker`, date, return) %>%
tidyr::spread(`active contract ticker`)
dplyr::select(market, `active contract ticker`, date, return)
dplyr::distinct(market, `active contract ticker`)
dplyr::select(market, `active contract ticker`, date, return) %>%
tidyr::spread(`active contract ticker`, return)
returns <- dplyr::select(market, `active contract ticker`, date, return)
View(returns)
market <- lapply(c(unique(cftc$`active contract ticker`), c("LAA Comdty", "LPA Comdty", "LLA Comdty", "LNA Comdty", "LTA Comdty", "LXA Comdty")), function(x){
message(paste0("\nLoading ", x, "."))
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
returns <- dplyr::select(data, date = `date front`, `price front`) %>%
dplyr::mutate(return = `price front` / dplyr::lag(`price front`, 1L) - 1L) %>%
dplyr::select(date, return) %>% dplyr::filter(complete.cases(.))
`open interest` <- dplyr::select(data, date = `date front`, `open interest`) %>%
dplyr::mutate(`open interest growth` = `open interest` / dplyr::lag(`open interest`, 1L) - 1L) %>%
dplyr::select(date, `open interest`, `open interest growth`) %>% dplyr::filter(complete.cases(.))
`aggregate open interest` <- dplyr::select(data, date = `date front`, `aggregate open interest`) %>%
dplyr::mutate(`aggregate open interest growth` = `aggregate open interest` / dplyr::lag(`aggregate open interest`, 1L) - 1L) %>%
dplyr::select(date, `aggregate open interest`, `aggregate open interest growth`) %>% dplyr::filter(complete.cases(.))
`roll yield` <- dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date") %>%
dplyr::mutate(`roll yield` = `price second` / `price front`) %>% dplyr::select(date, `roll yield`) %>% dplyr::filter(complete.cases(.))
plyr::join_all(list(returns, `open interest`, `aggregate open interest`, `roll yield`), by = "date", type = "full") %>%
dplyr::mutate(`active contract ticker` = x) %>% dplyr::select(`active contract ticker`, dplyr::everything())
}) %>% do.call(args = ., what = "rbind")
View(market)
market <- lapply(c(unique(cftc$`active contract ticker`), c("LAA Comdty", "LPA Comdty", "LLA Comdty", "LNA Comdty", "LTA Comdty", "LXA Comdty")), function(x){
message(paste0("\nLoading ", x, "."))
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
returns <- dplyr::select(data, date = `date front`, `price front`) %>%
dplyr::mutate(return = `price front` / dplyr::lag(`price front`, 1L) - 1L) %>%
dplyr::select(date, return) %>% dplyr::filter(complete.cases(.))
`open interest` <- dplyr::select(data, date = `date front`, `open interest`) %>%
dplyr::mutate(`open interest growth` = `open interest` / dplyr::lag(`open interest`, 1L) - 1L) %>%
dplyr::select(date, `open interest`, `open interest growth`) %>% dplyr::filter(complete.cases(.))
`aggregate open interest` <- dplyr::select(data, date = `date front`, `aggregate open interest`) %>%
dplyr::mutate(`aggregate open interest growth` = `aggregate open interest` / dplyr::lag(`aggregate open interest`, 1L) - 1L) %>%
dplyr::select(date, `aggregate open interest`, `aggregate open interest growth`) %>% dplyr::filter(complete.cases(.))
`roll yield` <- dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date") %>%
dplyr::mutate(`roll yield` = `price second` / `price front`) %>% dplyr::select(date, `roll yield`) %>% dplyr::filter(complete.cases(.))
plyr::join_all(list(returns, `open interest`, `aggregate open interest`, `roll yield`), by = "date", type = "full") %>%
dplyr::mutate(`active contract ticker` = x) %>% dplyr::select(`active contract ticker`, dplyr::everything()) %>%
dplyr::arrange(`active contract ticker`, date)
}) %>% do.call(args = ., what = "rbind")
View(market)
dplyr::select(market, `active contract ticker`, date, return) %>% dplyr::filter(complete.cases(.))
returns <- dplyr::select(market, `active contract ticker`, date, return) %>% dplyr::filter(complete.cases(.)) %>%
tidyr::spread(`active contract ticker`, return)
returns <- dplyr::select(market, `active contract ticker`, date, return) %>% dplyr::filter(complete.cases(.))
View(returns)
unique(cftc$`active contract ticker`)
View(tickers)
market <- lapply(unique(cftc$`active contract ticker`), function(x){
message(paste0("\nLoading ", x, "."))
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
returns <- dplyr::select(data, date = `date front`, `price front`) %>%
dplyr::mutate(return = `price front` / dplyr::lag(`price front`, 1L) - 1L) %>%
dplyr::select(date, return) %>% dplyr::filter(complete.cases(.))
`open interest` <- dplyr::select(data, date = `date front`, `open interest`) %>%
dplyr::mutate(`open interest growth` = `open interest` / dplyr::lag(`open interest`, 1L) - 1L) %>%
dplyr::select(date, `open interest`, `open interest growth`) %>% dplyr::filter(complete.cases(.))
`aggregate open interest` <- dplyr::select(data, date = `date front`, `aggregate open interest`) %>%
dplyr::mutate(`aggregate open interest growth` = `aggregate open interest` / dplyr::lag(`aggregate open interest`, 1L) - 1L) %>%
dplyr::select(date, `aggregate open interest`, `aggregate open interest growth`) %>% dplyr::filter(complete.cases(.))
`roll yield` <- dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date") %>%
dplyr::mutate(`roll yield` = `price second` / `price front`) %>% dplyr::select(date, `roll yield`) %>% dplyr::filter(complete.cases(.))
plyr::join_all(list(returns, `open interest`, `aggregate open interest`, `roll yield`), by = "date", type = "full") %>%
dplyr::mutate(`active contract ticker` = x) %>% dplyr::select(`active contract ticker`, dplyr::everything()) %>%
dplyr::arrange(`active contract ticker`, date)
}) %>% do.call(args = ., what = "rbind")
returns <- dplyr::select(market, `active contract ticker`, date, return) %>% dplyr::filter(complete.cases(.)) %>%
tidyr::spread(`active contract ticker`, return)
returns
?unique(cftc$`active contract ticker`)
?readr::write_excel_csv2()
dplyr::slice(returns, (i - 252L):i)
i <- 253L
dplyr::slice(returns, (i - 252L):i)
View(returns)
returns <- dplyr::select(market, `active contract ticker`, date, return) %>% dplyr::filter(complete.cases(.)) %>%
tidyr::spread(`active contract ticker`, return) %>% dplyr::filter(date >= as.Date("1997-07-01"))
returns
for (i in 253L:255L) readr::write_csv2()
dplyr::slice(returns, (i - 252L):i)
cor(dplyr::slice(returns, (i - 252L):i))
cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date))
?cor(
?cor
cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date), use = "everything")
cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date), use = "pairwise.complete.obs")
file <- "data/CFTC data.xlsm"
cftc <- lapply((dplyr::filter(tickers, CFTC == TRUE, subsector != "index"))$`active contract ticker`, function(x){
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::filter(complete.cases(.))
long <- dplyr::select(data, c("Date..1", "PX_LAST..2")) %>% dplyr::mutate(date = as.Date(`Date..1`)) %>% dplyr::select(date, long = `PX_LAST..2`)
short <- dplyr::select(data, c("Date..3", "PX_LAST..4")) %>% dplyr::mutate(date = as.Date(`Date..3`)) %>% dplyr::select(date, short = `PX_LAST..4`)
dplyr::full_join(long, short, by = "date") %>%
dplyr::mutate(CHP = long / (long + short),
date = RQuantLib::advance(dates = date, calendar = (dplyr::filter(tickers, `active contract ticker` == x))$calendar, n = 3L, timeUnit = 0L),
`active contract ticker` = x) %>%
dplyr::select(`active contract ticker`, date, CHP)
}) %>% do.call(args = ., what = "rbind")
cftc <- rbind(cftc, rbind(cftc %>% dplyr::filter(`active contract ticker` == "HUA Comdty", date < "2006-09-01" %>% as.Date),
cftc %>% dplyr::filter(`active contract ticker` == "XBA Comdty", date >= "2006-09-01" %>% as.Date)) %>%
dplyr::mutate(`active contract ticker` = "XBWA Comdty")) %>% dplyr::filter(!`active contract ticker` %in% c("HUA Comdty", "XBA Comdty"))
file <- "data/Market data.xlsm"
market <- lapply(unique(cftc$`active contract ticker`), function(x){
message(paste0("\nLoading ", x, "."))
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
returns <- dplyr::select(data, date = `date front`, `price front`) %>%
dplyr::mutate(return = `price front` / dplyr::lag(`price front`, 1L) - 1L) %>%
dplyr::select(date, return) %>% dplyr::filter(complete.cases(.))
`open interest` <- dplyr::select(data, date = `date front`, `open interest`) %>%
dplyr::mutate(`open interest growth` = `open interest` / dplyr::lag(`open interest`, 1L) - 1L) %>%
dplyr::select(date, `open interest`, `open interest growth`) %>% dplyr::filter(complete.cases(.))
`aggregate open interest` <- dplyr::select(data, date = `date front`, `aggregate open interest`) %>%
dplyr::mutate(`aggregate open interest growth` = `aggregate open interest` / dplyr::lag(`aggregate open interest`, 1L) - 1L) %>%
dplyr::select(date, `aggregate open interest`, `aggregate open interest growth`) %>% dplyr::filter(complete.cases(.))
`roll yield` <- dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date") %>%
dplyr::mutate(`roll yield` = `price second` / `price front`) %>% dplyr::select(date, `roll yield`) %>% dplyr::filter(complete.cases(.))
plyr::join_all(list(returns, `open interest`, `aggregate open interest`, `roll yield`), by = "date", type = "full") %>%
dplyr::mutate(`active contract ticker` = x) %>% dplyr::select(`active contract ticker`, dplyr::everything()) %>%
dplyr::arrange(`active contract ticker`, date)
}) %>% do.call(args = ., what = "rbind")
returns <- dplyr::select(market, `active contract ticker`, date, return) %>% dplyr::filter(complete.cases(.)) %>%
tidyr::spread(`active contract ticker`, return) %>% dplyr::filter(date >= as.Date("1997-07-01"))
cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date), use = "pairwise.complete.obs")
x <- "return"
dplyr::select(market, `active contract ticker`, date, !! x)
dplyr::slice(returns, i) %>% dplyr::select(date)
dplyr::slice(returns, i) %>% dplyr::select(date) %>% purrr::flatten_chr()
dplyr::slice(returns, i) %>% dplyr::select(date) %>% purrr::flatten_raw()
dplyr::slice(returns, i) %>% dplyr::select(date) %>% purrr::flatten()
dplyr::slice(returns, i)$date
paste0("../results/correlations/matrices/", x, " - ",
gsub(dplyr::slice(returns, i)$date, pattern = "-", replacement = ""), "-",
gsub(dplyr::slice(returns, i - 252L)$date, pattern = "-", replacement = ""), ".csv"
)
readr::write_csv2(x = cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date), use = "pairwise.complete.obs"),
path = paste0("../results/correlations/matrices/", x, " - ",
gsub(dplyr::slice(returns, i)$date, pattern = "-", replacement = ""), "-",
gsub(dplyr::slice(returns, i - 252L)$date, pattern = "-", replacement = ""), ".csv"
)
)
cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date), use = "pairwise.complete.obs")
as.data.frame.matrix(cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date), use = "pairwise.complete.obs"))
readr::write_csv2(x = as.data.frame.matrix(cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date), use = "pairwise.complete.obs")),
path = paste0("../results/correlations/matrices/", x, " - ",
gsub(dplyr::slice(returns, i)$date, pattern = "-", replacement = ""), "-",
gsub(dplyr::slice(returns, i - 252L)$date, pattern = "-", replacement = ""), ".csv"
)
)
write.csv2(x = cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date), use = "pairwise.complete.obs"),
file = paste0("../results/correlations/matrices/", x, " - ",
gsub(dplyr::slice(returns, i)$date, pattern = "-", replacement = ""), "-",
gsub(dplyr::slice(returns, i - 252L)$date, pattern = "-", replacement = ""), ".csv"
)
)
?write.csv2
write.csv2(x = cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date), use = "pairwise.complete.obs"),
file = paste0(x, " - ",
gsub(dplyr::slice(returns, i)$date, pattern = "-", replacement = ""), "-",
gsub(dplyr::slice(returns, i - 252L)$date, pattern = "-", replacement = ""), ".csv"
)
)
write.csv2(x = cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date), use = "pairwise.complete.obs"),
file = paste0("~/results/correlations/matrices/", x, " - ",
gsub(dplyr::slice(returns, i)$date, pattern = "-", replacement = ""), "-",
gsub(dplyr::slice(returns, i - 252L)$date, pattern = "-", replacement = ""), ".csv"
)
)
write.csv2(x = cor(dplyr::slice(returns, (i - 252L):i) %>% dplyr::select(-date), use = "pairwise.complete.obs"),
file = paste0("./results/correlations/matrices/", x, " - ",
gsub(dplyr::slice(returns, i)$date, pattern = "-", replacement = ""), "-",
gsub(dplyr::slice(returns, i - 252L)$date, pattern = "-", replacement = ""), ".csv"
)
)
nrow(returns)
for (i in c("return", "open interest", "open interest growth", "aggregate open interest", "aggregate open interest growth", "roll yield")) {
data <- dplyr::select(market, `active contract ticker`, date, !! i) %>% dplyr::filter(complete.cases(.)) %>%
tidyr::spread(`active contract ticker`, !! i) %>% dplyr::filter(date >= as.Date("1997-07-01"))
for (j in 253L:nrow(returns))
write.csv2(x = cor(dplyr::slice(returns, (j - 252L):j) %>% dplyr::select(-date), use = "pairwise.complete.obs"),
file = paste0("./results/correlations/matrices/", x, " - ",
gsub(dplyr::slice(returns, j - 252L)$date, pattern = "-", replacement = ""), "-",
gsub(dplyr::slice(returns, j)$date, pattern = "-", replacement = ""), ".csv"
)
)
}
for (i in c("return", "open interest", "open interest growth", "aggregate open interest", "aggregate open interest growth", "roll yield")) {
data <- dplyr::select(market, `active contract ticker`, date, !! i) %>% dplyr::filter(complete.cases(.)) %>%
tidyr::spread(`active contract ticker`, !! i) %>% dplyr::filter(date >= as.Date("1997-07-01"))
for (j in 253L:nrow(returns))
write.csv2(x = cor(dplyr::slice(returns, (j - 252L):j) %>% dplyr::select(-date), use = "pairwise.complete.obs"),
file = paste0("./results/correlations/matrices/", i, " - ",
gsub(dplyr::slice(returns, j - 252L)$date, pattern = "-", replacement = ""), "-",
gsub(dplyr::slice(returns, j)$date, pattern = "-", replacement = ""), ".csv"
)
)
}
library(magrittr)
file <- "data/Tickers.xlsx"; tickers <- readxl::read_excel(file, sheet = "Tickers", skip = 0L)
## cftc data
file <- "data/CFTC data.xlsm"
cftc <- lapply((dplyr::filter(tickers, CFTC == TRUE, subsector != "index"))$`active contract ticker`, function(x){
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::filter(complete.cases(.))
long <- dplyr::select(data, c("Date..1", "PX_LAST..2")) %>% dplyr::mutate(date = as.Date(`Date..1`)) %>% dplyr::select(date, long = `PX_LAST..2`)
short <- dplyr::select(data, c("Date..3", "PX_LAST..4")) %>% dplyr::mutate(date = as.Date(`Date..3`)) %>% dplyr::select(date, short = `PX_LAST..4`)
dplyr::full_join(long, short, by = "date") %>%
dplyr::mutate(CHP = long / (long + short),
date = RQuantLib::advance(dates = date, calendar = (dplyr::filter(tickers, `active contract ticker` == x))$calendar, n = 3L, timeUnit = 0L),
`active contract ticker` = x) %>%
dplyr::select(`active contract ticker`, date, CHP)
}) %>% do.call(args = ., what = "rbind")
### Reconciliating gasoline COT time series: switch from unleaded gasoline (HUA Comdty) to RBOB gasoline (XBA Comdty) on 2006-09-01
cftc <- rbind(cftc, rbind(cftc %>% dplyr::filter(`active contract ticker` == "HUA Comdty", date < "2006-09-01" %>% as.Date),
cftc %>% dplyr::filter(`active contract ticker` == "XBA Comdty", date >= "2006-09-01" %>% as.Date)) %>%
dplyr::mutate(`active contract ticker` = "XBWA Comdty")) %>% dplyr::filter(!`active contract ticker` %in% c("HUA Comdty", "XBA Comdty"))
file <- "data/Market data.xlsm"
market <- lapply(unique(cftc$`active contract ticker`), function(x){
message(paste0("\nLoading ", x, "."))
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::select(`date front` = `Date..1`, `price front` = `PX_LAST..5`, `open interest` = `OPEN_INT..7`,
`aggregate open interest` = FUT_AGGTE_OPEN_INT, `aggregate volume` = FUT_AGGTE_VOL,
`date second` = `Date..11`, `price second` = `PX_LAST..15`) %>%
dplyr::slice(2L:n()) %>%
dplyr::mutate_at(.vars = dplyr::vars(`date front`, `date second`), .funs = dplyr::funs(as.Date)) %>%
dplyr::mutate_at(.vars = dplyr::vars(-c("date front", "date second")), .funs = dplyr::funs(as.numeric))
returns <- dplyr::select(data, date = `date front`, `price front`) %>%
dplyr::mutate(return = `price front` / dplyr::lag(`price front`, 1L) - 1L) %>%
dplyr::select(date, return) %>% dplyr::filter(complete.cases(.))
`open interest` <- dplyr::select(data, date = `date front`, `open interest`) %>%
dplyr::mutate(`open interest growth` = `open interest` / dplyr::lag(`open interest`, 1L) - 1L) %>%
dplyr::select(date, `open interest`, `open interest growth`) %>% dplyr::filter(complete.cases(.))
`aggregate open interest` <- dplyr::select(data, date = `date front`, `aggregate open interest`) %>%
dplyr::mutate(`aggregate open interest growth` = `aggregate open interest` / dplyr::lag(`aggregate open interest`, 1L) - 1L) %>%
dplyr::select(date, `aggregate open interest`, `aggregate open interest growth`) %>% dplyr::filter(complete.cases(.))
`roll yield` <- dplyr::full_join(dplyr::select(data, date = `date front`, `price front`), dplyr::select(data, date = `date second`, `price second`), by = "date") %>%
dplyr::mutate(`roll yield` = `price second` / `price front`) %>% dplyr::select(date, `roll yield`) %>% dplyr::filter(complete.cases(.))
plyr::join_all(list(returns, `open interest`, `aggregate open interest`, `roll yield`), by = "date", type = "full") %>%
dplyr::mutate(`active contract ticker` = x) %>% dplyr::select(`active contract ticker`, dplyr::everything()) %>%
dplyr::arrange(`active contract ticker`, date)
}) %>% do.call(args = ., what = "rbind")
for (i in c("return", "open interest", "open interest growth", "aggregate open interest", "aggregate open interest growth", "roll yield")) {
data <- dplyr::select(market, `active contract ticker`, date, !! i) %>% dplyr::filter(complete.cases(.)) %>%
tidyr::spread(`active contract ticker`, !! i) %>% dplyr::filter(date >= as.Date("1997-07-01"))
for (j in 253L:nrow(data))
write.csv2(x = cor(dplyr::slice(data, (j - 252L):j) %>% dplyr::select(-date), use = "pairwise.complete.obs"),
file = paste0("./results/correlations/matrices/", i, " - ",
gsub(dplyr::slice(data, j - 252L)$date, pattern = "-", replacement = ""), "-",
gsub(dplyr::slice(data, j)$date, pattern = "-", replacement = ""), ".csv"
)
)
}
cftc
file <- "data/CFTC data.xlsm"
cftc <- lapply((dplyr::filter(tickers, CFTC == TRUE, subsector != "index"))$`active contract ticker`, function(x){
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::filter(complete.cases(.))
long <- dplyr::select(data, c("Date..1", "PX_LAST..2")) %>% dplyr::mutate(date = as.Date(`Date..1`)) %>% dplyr::select(date, long = `PX_LAST..2`)
short <- dplyr::select(data, c("Date..3", "PX_LAST..4")) %>% dplyr::mutate(date = as.Date(`Date..3`)) %>% dplyr::select(date, short = `PX_LAST..4`)
dplyr::full_join(long, short, by = "date") %>%
dplyr::mutate(CHP = long / (long + short),
date = RQuantLib::advance(dates = date, calendar = (dplyr::filter(tickers, `active contract ticker` == x))$calendar, n = 3L, timeUnit = 0L),
`active contract ticker` = x) %>%
dplyr::select(`active contract ticker`, date, CHP)
}) %>% do.call(args = ., what = "rbind")
### Reconciliating gasoline COT time series: switch from unleaded gasoline (HUA Comdty) to RBOB gasoline (XBA Comdty) on 2006-09-01
cftc <- rbind(cftc, rbind(cftc %>% dplyr::filter(`active contract ticker` == "HUA Comdty", date < "2006-09-01" %>% as.Date),
cftc %>% dplyr::filter(`active contract ticker` == "XBA Comdty", date >= "2006-09-01" %>% as.Date)) %>%
dplyr::mutate(`active contract ticker` = "XBWA Comdty")) %>% dplyr::filter(!`active contract ticker` %in% c("HUA Comdty", "XBA Comdty")) %>%
tidyr::spread(`active contract ticker`, CHP)
cftc
file <- "data/CFTC data.xlsm"
cftc <- lapply((dplyr::filter(tickers, CFTC == TRUE, subsector != "index"))$`active contract ticker`, function(x){
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::filter(complete.cases(.))
long <- dplyr::select(data, c("Date..1", "PX_LAST..2")) %>% dplyr::mutate(date = as.Date(`Date..1`)) %>% dplyr::select(date, long = `PX_LAST..2`)
short <- dplyr::select(data, c("Date..3", "PX_LAST..4")) %>% dplyr::mutate(date = as.Date(`Date..3`)) %>% dplyr::select(date, short = `PX_LAST..4`)
dplyr::full_join(long, short, by = "date") %>%
dplyr::mutate(CHP = long / (long + short),
date = RQuantLib::advance(dates = date, calendar = (dplyr::filter(tickers, `active contract ticker` == x))$calendar, n = 3L, timeUnit = 0L),
`active contract ticker` = x) %>%
dplyr::select(`active contract ticker`, date, CHP)
}) %>% do.call(args = ., what = "rbind")
### Reconciliating gasoline COT time series: switch from unleaded gasoline (HUA Comdty) to RBOB gasoline (XBA Comdty) on 2006-09-01
cftc <- rbind(cftc, rbind(cftc %>% dplyr::filter(`active contract ticker` == "HUA Comdty", date < "2006-09-01" %>% as.Date),
cftc %>% dplyr::filter(`active contract ticker` == "XBA Comdty", date >= "2006-09-01" %>% as.Date)) %>%
dplyr::mutate(`active contract ticker` = "XBWA Comdty")) %>% dplyr::filter(!`active contract ticker` %in% c("HUA Comdty", "XBA Comdty")) %>%
tidyr::spread(`active contract ticker`, CHP) %>% dplyr::filter(date >= start)
file <- "data/Tickers.xlsx"; tickers <- readxl::read_excel(file, sheet = "Tickers", skip = 0L); start <- "1997-07-01"
## cftc data
file <- "data/CFTC data.xlsm"
cftc <- lapply((dplyr::filter(tickers, CFTC == TRUE, subsector != "index"))$`active contract ticker`, function(x){
data <- readxl::read_excel(file, sheet = x, skip = 1L) %>% dplyr::filter(complete.cases(.))
long <- dplyr::select(data, c("Date..1", "PX_LAST..2")) %>% dplyr::mutate(date = as.Date(`Date..1`)) %>% dplyr::select(date, long = `PX_LAST..2`)
short <- dplyr::select(data, c("Date..3", "PX_LAST..4")) %>% dplyr::mutate(date = as.Date(`Date..3`)) %>% dplyr::select(date, short = `PX_LAST..4`)
dplyr::full_join(long, short, by = "date") %>%
dplyr::mutate(CHP = long / (long + short),
date = RQuantLib::advance(dates = date, calendar = (dplyr::filter(tickers, `active contract ticker` == x))$calendar, n = 3L, timeUnit = 0L),
`active contract ticker` = x) %>%
dplyr::select(`active contract ticker`, date, CHP)
}) %>% do.call(args = ., what = "rbind")
### Reconciliating gasoline COT time series: switch from unleaded gasoline (HUA Comdty) to RBOB gasoline (XBA Comdty) on 2006-09-01
cftc <- rbind(cftc, rbind(cftc %>% dplyr::filter(`active contract ticker` == "HUA Comdty", date < "2006-09-01" %>% as.Date),
cftc %>% dplyr::filter(`active contract ticker` == "XBA Comdty", date >= "2006-09-01" %>% as.Date)) %>%
dplyr::mutate(`active contract ticker` = "XBWA Comdty")) %>% dplyr::filter(!`active contract ticker` %in% c("HUA Comdty", "XBA Comdty")) %>%
tidyr::spread(`active contract ticker`, CHP) %>% dplyr::filter(date >= as.Date(start))
cftc
for (j in 53L:nrow(data))
write.csv2(x = cor(dplyr::slice(data, (j - 52L):j) %>% dplyr::select(-date), use = "pairwise.complete.obs"),
file = paste0("./results/correlations/matrices/CHP - ",
gsub(dplyr::slice(data, j - 252L)$date, pattern = "-", replacement = ""), "-",
gsub(dplyr::slice(data, j)$date, pattern = "-", replacement = ""), ".csv"
)
)
cor(dplyr::slice(cftc, (j - 52L):j) %>% dplyr::select(-date), use = "pairwise.complete.obs")
